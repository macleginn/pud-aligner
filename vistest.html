<html>
  <head>
    <meta charset="utf-8">
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css"/>
    <style>
      #mynetwork {
        border: 1px solid gray;
        margin: 2px;
        display: flex;
        /*min-height: 600px;*/
      }
      .parse {
        border: 1px solid gray;
        padding: 20px;
        margin: 2px;
        font-family: monospace;
        /*max-height: 250px;*/
        overflow: scroll;
      }
      .form {
        border: 1px solid gray;
        padding: 10px;
        padding-left: 20px;
        margin: 2px;
      }
      p {
        margin-top: 3px;
        margin-bottom: 7px;
      }
    </style>
  </head>
  <body style="display: grid; grid-template-columns: 50% 50%; grid-template-rows: 120px 250px 700px;">
    <div class="form" id="form1" style="grid-column: 1/2; grid-row: auto;">
      <p>Select corpus: <select name="corpus" id="selectCorpus"></select> <button onclick="chooseCorpus();">Retrieve sentences</button></p>
    </div>
    <div class="form" id="form2" style="grid-column: 2/3; grid-row: auto;">
      <p>Select sentence by number (from 1 to 1000): <input type="text" id="sentenceNum"/> <button onclick="showSentenceByNum();">Show sentence</button></p>
      <p>Select sentence by id: <input type="text" id="sentenceID"/> <button onclick="showSentenceByID();">Show sentence</button></p>
      <p style="margin-top: 17px;"><button onclick="prevSentence();">&lt;&lt; Previous sentence</button><button onclick="nextSentence();">Next sentence &gt;&gt;</button></p>
    </div>

    <div class="parse" id="parse1" style="grid-column: 1/2; grid-row: auto;">Parse 1</div>
    <div class="parse" id="parse2" style="grid-column: 2/3; grid-row: auto;">Parse 2</div>
    
    <div id="mynetwork" style="grid-column: 1/3; grid-row: auto;">Canvas</div>
    <script>

      const requestURL = 'http://127.0.0.1:5000/';

      const parse1 = `# sent_id = n01001013
# text = For those who follow social media transitions on Capitol Hill, this will be a little different.
1	For	for	ADP	IN	_	2	case	2:case	_
2	those	those	PRON	DT	Number=Plur|PronType=Dem	17	obl	4:nsubj|17:obl:for	_
3	who	who	PRON	WP	PronType=Rel	4	nsubj	2:ref	_
4	follow	follow	VERB	VBP	Mood=Ind|Tense=Pres|VerbForm=Fin	2	acl:relcl	2:acl:relcl	_
5	social	social	ADJ	JJ	Degree=Pos	6	amod	6:amod	_
6	media	media	NOUN	NN	Number=Sing	7	compound	7:compound	_
7	transitions	transition	NOUN	NNS	Number=Plur	4	obj	4:obj	_
8	on	on	ADP	IN	_	10	case	10:case	_
9	Capitol	capitol	PROPN	NN	Number=Sing	10	compound	10:compound	_
10	Hill	hill	PROPN	NN	Number=Sing	7	nmod	7:nmod:on	SpaceAfter=No
11	,	,	PUNCT	,	_	17	punct	17:punct	_
12	this	this	PRON	DT	Number=Sing|PronType=Dem	17	nsubj	17:nsubj	_
13	will	will	AUX	MD	VerbForm=Fin	17	aux	17:aux	_
14	be	be	AUX	VB	VerbForm=Inf	17	cop	17:cop	_
15	a	a	DET	DT	Definite=Ind|PronType=Art	16	det	16:det	_
16	little	little	ADJ	JJ	Degree=Pos	17	obl:npmod	17:obl:npmod	_
17	different	different	ADJ	JJ	Degree=Pos	0	root	0:root	SpaceAfter=No
18	.	.	PUNCT	.	_	17	punct	17:punct	_`

      const parse2 = `# sent_id = n01001013
# text = Для тех, кто следит за передачей всех материалов, появившихся в социальных сетях о Конгрессе, это будет происходить несколько по-другому.
# text_en = For those who follow social media transitions on Capitol Hill, this will be a little different.
1	Для	_	ADP	IN	_	2	case	_	_
2	тех	_	DET	DT	Animacy=Anim|Case=Gen|Number=Plur	20	obl	_	SpaceAfter=No
3	,	_	PUNCT	,	_	5	punct	_	_
4	кто	_	PRON	WP	Animacy=Anim|Case=Nom|Gender=Masc	5	nsubj	_	_
5	следит	_	VERB	VBC	Aspect=Imp|Mood=Ind|Number=Sing|Person=3|Tense=Pres	2	acl:relcl	_	_
6	за	_	ADP	IN	_	7	case	_	_
7	передачей	_	NOUN	NN	Animacy=Inan|Case=Ins|Gender=Fem|Number=Sing|Person=3	5	obl	_	_
8	всех	_	DET	DT	Animacy=Inan|Case=Gen|Number=Plur	9	det	_	_
9	материалов	_	NOUN	NN	Animacy=Inan|Case=Gen|Gender=Masc|Number=Plur|Person=3	7	nmod	_	SpaceAfter=No
10	,	_	PUNCT	,	_	11	punct	_	_
11	появившихся	_	VERB	VBN	Animacy=Inan|Aspect=Perf|Case=Gen|Number=Plur|Tense=Past|Variant=Long|VerbForm=Part|Voice=Act	9	amod	_	_
12	в	_	ADP	IN	_	14	case	_	_
13	социальных	_	ADJ	JJ	Animacy=Inan|Number=Plur|Variant=Long	14	amod	_	_
14	сетях	_	NOUN	NN	Animacy=Inan|Gender=Fem|Number=Plur|Person=3	11	obl	_	_
15	о	_	ADP	IN	_	16	case	_	_
16	Конгрессе	_	PROPN	NN	Animacy=Inan|Gender=Masc|Number=Sing|Person=3	11	obl	_	SpaceAfter=No
17	,	_	PUNCT	,	_	5	punct	_	_
18	это	_	PRON	DT	Animacy=Inan|Case=Nom|Gender=Neut|Number=Sing	20	nsubj	_	_
19	будет	_	VERB	VBC	Aspect=Imp|Mood=Ind|Number=Sing|Person=3|Tense=Fut	20	aux	_	_
20	происходить	_	VERB	VB	Aspect=Imp	0	root	_	_
21	несколько	_	ADV	RB	_	22	advmod	_	_
22	по-другому	_	ADV	RB	_	20	advmod	_	SpaceAfter=No
23	.	_	PUNCT	.	_	20	punct	_	_`

      function chooseCorpus() {
        window.tableName = $('#selectCorpus').val();
        let request = $.get(requestURL + 'getids/' + window.tableName);
        request.done(data => {
          window.sentenceIDs = data;
          $('#sentenceNum').val("1");
          showSentenceByNum();
        });
        request.fail(() => {
          alert('Failed to fetch sentence IDs from the server.');
        });
      }

      function showSentenceByNum() {
        window.sentenceNum = parseInt($('#sentenceNum').val());
        let index = window.sentenceNum-1,
            request = $.get(
              requestURL + 
              tableName + '/' +
              window.sentenceIDs[index]['document_id'] + '/' +
              window.sentenceIDs[index]['sentence_id']);
        request.done(data => {
          byID('parse1').innerText = data[0]['en'];
          byID('parse2').innerText = data[0]['ru'];
          window.nodes.clear();
          window.edges.clear();
          addUDParse(data[0]['en'], window.nodes, window.edges, 'top');
          addUDParse(data[0]['ru'], window.nodes, window.edges, 'bottom');
        });
        request.fail(() => {
          alert('Failed to fetch the sentence from the server.');
        });
      }

      function prevSentence() {
        if (window.sentenceNum > 1) {
          window.sentenceNum--;
          $('#sentenceNum').val(window.sentenceNum);
          showSentenceByNum();
        }
      }

      function nextSentence() {
        if (window.sentenceNum < 1000) {
          window.sentenceNum++;
          $('#sentenceNum').val(window.sentenceNum);
          showSentenceByNum();
        }
      }

      function byID(id) {
        return document.getElementById(id);
      }

      let hOffset = 100,
          vOffset = 200,
          topNodes = new Set(),
          bottomNodes = new Set();

      function addUDParse(parseString, nodes, edges, layer) {
        // First pass: create nodes
        let leftOffset = 0,
            lines = parseString.split('\n'),
            i = 0;
        while (lines[i].slice(0, 1) === '#')
          i++;
        let nCommentLines = i;
        while (i < lines.length) {
          let fields = lines[i].split('\t'),
              id = layer+fields[0],
              label = fields[1];
          if (layer === 'top')
            topNodes.add(id);
          else
            bottomNodes.add(id);
          nodes.add({
            id: id,
            label: label,
            // TODO: make adaptive
            x: -1000 + hOffset * (i - nCommentLines),
            y: layer === 'top' ? 0 : vOffset
          });
          i++;
        }
        i = nCommentLines;
        while (i < lines.length) {
          let fields = lines[i].split('\t'),
              id = layer+fields[0],
              edgeLabel = fields[7],
              parent = layer+fields[6];
          if (edgeLabel !== 'root' && edgeLabel !== 'punct') // Ignore punctuation to reduce clutter
            edges.add({
              id: id+'->'+parent,
              arrows: 'from',
              from: id,
              to: parent,
              label: edgeLabel
            });
          i++;
        }
      }

      function addRemoveEdge(edges, from, to) {
        let edgeID = from + '->' + to,
            edgeIDInverse = to + '->' + from;
        if (edges._data.hasOwnProperty(edgeID))
          edges.remove({id: edgeID});
        else if (edges._data.hasOwnProperty(edgeIDInverse))
          edges.remove({id: edgeIDInverse});
        else
          edges.add({
            id: edgeID,
            from: from,
            to: to,
            arrows: { to: false },
            smooth: false,
            color: { color:'grey' },
            dashes: true
          });
      }

      let edgeArr = [];

      function clickHandler(params) {
        if (params.nodes.length !== 0) {
          let nodeID = params.nodes[0];
          if (edgeArr.length == 0)
            edgeArr.push(nodeID)
          else {
            let oldNodeID = edgeArr[0];
            if ((topNodes.has(nodeID) && topNodes.has(oldNodeID)) ||
                (bottomNodes.has(nodeID) && bottomNodes.has(oldNodeID)))
              edgeArr = [];
            else {
              addRemoveEdge(edges, oldNodeID, nodeID);
              edgeArr = [];
              window.network.unselectAll();
            }
          }
        } 
      }

      
      let nodesArr = [];
      window.nodes = new vis.DataSet(nodesArr);
          
      let edgesArr = [];
      window.edges = new vis.DataSet(edgesArr);

      // create a network
      let container = byID('mynetwork'),
          data = {
        nodes: window.nodes,
        edges: window.edges
        },
          options = {
        physics:true,
        edges: {
          smooth: {
            type: 'curvedCCW',
            forceDirection: 'vertical'
          }
        },
        nodes: {
          mass: 10,
          fixed: true,
          font: {
            size: 16
          },
          margin: 10,
          color: '#CDDC39'
        },
      };

      document.addEventListener("DOMContentLoaded", function(event) {
        let request = $.get(requestURL + 'corpora');
        request.done(data => {
          $.each(data, (_, val) => {
            $('#selectCorpus').append(
              $('<option>')
              .attr('val', val.name)
              .text(val.name)
              );
          });
          chooseCorpus();
        });
        request.fail(() => { alert('Failed to fetch list of corpora from the server.') });
        window.network = new vis.Network(container, data, options);
        window.network.on("click", (params) => { clickHandler(params); });
        // byID('parse1').innerText = parse1;
        // byID('parse2').innerText = parse2;
        // addUDParse(parse1, nodes, edges, 'top');
        // addUDParse(parse2, nodes, edges, 'bottom');
      });
    </script>
  </body>
</html>